{% extends "base.html" %}
{% block title %}Submit Complaint{% endblock %}

<a href="{{ url_for('complaints.dashboard') }}" 
   class="inline-block mb-4 px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
  ‚Üê Back
</a>

{% block content %}
<div class="max-w-4xl mx-auto mt-10 bg-white/70 backdrop-blur-md p-8 rounded-2xl shadow-lg">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-semibold text-indigo-700">Submit a Complaint</h2>
    <a href="{{ url_for('complaints.dashboard') }}" 
       class="px-4 py-2 bg-indigo-600 text-white rounded-lg shadow hover:bg-indigo-700 transition">
      Dashboard
    </a>
  </div>

  <!-- Complaint Form -->
  <form method="post" id="complaintForm" onsubmit="return validateComplaintForm()" novalidate>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Complaint Type -->
      <div>
        <label class="block font-medium mb-1">Complaint Type</label>
        <input list="type_list" name="complaint_type_input" id="complaint_type_input"
               class="w-full mb-1 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none" 
               placeholder="Type or select a type">
        <datalist id="type_list">
          {% for t in types %}
            <option value="{{ t.name }}"></option>
          {% endfor %}
        </datalist>
        <span id="type-error" class="error-message text-red-500 text-sm"></span>
      </div>

      <!-- Area -->
      <div>
        <label class="block font-medium mb-1">Area</label>
        <input list="area_list" name="area_input" id="area_input"
               class="w-full mb-1 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none" 
               placeholder="Type or select an area">
        <datalist id="area_list">
          {% for a in areas %}
            <option value="{{ a.name }}"></option>
          {% endfor %}
        </datalist>
        <span id="area-error" class="error-message text-red-500 text-sm"></span>
      </div>
    </div>

    <!-- Description -->
    <div class="mt-4">
      <label class="block font-medium mb-1">Description</label>
      <textarea name="description" id="description"
                class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none" 
                rows="4" placeholder="Enter detailed complaint..."></textarea>
      <span id="desc-error" class="error-message text-red-500 text-sm"></span>
    </div>

    <!-- Submit button -->
    <button type="submit" 
            class="mt-6 bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg shadow transition">
      Submit Complaint
    </button>
  </form>
</div>

<!-- Complaints Table -->
<div class="max-w-5xl mx-auto mt-10 bg-white/70 backdrop-blur-md p-8 rounded-2xl shadow-lg">
  <h2 class="text-2xl font-semibold text-indigo-700 mb-4">My Complaints</h2>
  <div class="overflow-x-auto">
    <table class="w-full border-collapse text-sm text-left">
      <thead class="bg-indigo-100 text-indigo-900">
        <tr>
          <th class="border p-2">Type</th>
          <th class="border p-2">Area</th>
          <th class="border p-2">Description</th>
          <th class="border p-2">Status</th>
          <th class="border p-2 text-center">Actions</th>
        </tr>
      </thead> 
      <tbody>
        {% for c in complaints %}
        <tr class="border-b hover:bg-gray-50 transition">
          <td class="border p-2">{{ c.complaint_type.name }}</td>
          <td class="border p-2">{{ c.area.name }}</td>
          <td class="border p-2">{{ c.text }}</td>
          <td class="border p-2 font-medium {{ 'text-green-700' if c.status == 'resolved' else 'text-yellow-700' }}">
            {{ c.status }}
          </td>
          <td class="border p-2 text-center">
            {% if c.status == 'pending' %}
            <form method="post" 
                  action="{{ url_for('complaints.delete_complaint', complaint_id=c.id) }}" 
                  style="display:inline;" 
                  onsubmit="return confirm('Are you sure you want to delete this complaint?');">
              <button type="submit" class="text-red-600 hover:underline font-medium">Delete</button>
            </form>
            {% else %}
            <span class="text-gray-500 italic">Not allowed</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Flash Message Popup -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div id="popup-message" class="popup-flash">
      {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<style>
.popup-flash {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 9999;
  animation: fadeInOut 3.5s ease-in-out;
}

.flash {
  padding: 16px 32px;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1.1rem;
  text-align: center;
  min-width: 260px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
  transform: scale(0.9);
  animation: popupBounce 0.4s ease forwards;
}

.flash.success {
  background-color: #bbf7d0;
  color: #064e3b;
  border: 1px solid #34d399;
}

.flash.error {
  background-color: #fecaca;
  color: #7f1d1d;
  border: 1px solid #f87171;
}

@keyframes popupBounce {
  0% { opacity: 0; transform: scale(0.85); }
  40% { opacity: 1; transform: scale(1.05); }
  100% { transform: scale(1); }
}

@keyframes fadeInOut {
  0% { opacity: 0; }
  10% { opacity: 1; }
  90% { opacity: 1; }
  100% { opacity: 0; }
}

.error-message {
  display: block;
  margin-top: 2px;
}
</style>

<script>
function validateComplaintForm() {
  let valid = true;
  document.getElementById("type-error").textContent = "";
  document.getElementById("area-error").textContent = "";
  document.getElementById("desc-error").textContent = "";

  const type = document.getElementById("complaint_type_input").value.trim();
  const area = document.getElementById("area_input").value.trim();
  const desc = document.getElementById("description").value.trim();

  if (type.length < 3) {
    document.getElementById("type-error").textContent = "Please enter a valid complaint type.";
    valid = false;
  }
  if (area.length < 3) {
    document.getElementById("area-error").textContent = "Please enter a valid area.";
    valid = false;
  }
  if (desc.length < 10) {
    document.getElementById("desc-error").textContent = "Description must be at least 10 characters.";
    valid = false;
  }

  return valid;
}

document.addEventListener("DOMContentLoaded", function() {
  const popup = document.getElementById("popup-message");
  if (popup) {
    setTimeout(() => popup.style.display = "none", 3500);
  }
});
</script>
{% endblock %}
